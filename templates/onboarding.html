<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GranterAI | Build Your Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/master_stylesheet.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Onboarding-specific stepper styles */
        .step.step-active .step-circle {
            background-color: var(--brand-green);
            border-color: var(--brand-green);
            color: white;
        }
        .step.step-active .step-label {
            color: var(--brand-green);
        }
        .step.step-completed .step-circle {
            background-color: var(--brand-green-light);
            border-color: var(--brand-green);
            color: var(--brand-green);
        }
        .step.step-completed .step-line {
            background-color: var(--brand-green);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/" class="flex items-center">
                <img src="/static/grantera-high-resolution-logo-transparent.png" alt="GranterAI Logo" class="h-10 w-auto">
            </a>
            <span class="text-gray-500 font-semibold">Profile Setup</span>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12 md:py-16">
        <div class="max-w-4xl mx-auto">
            
            <form id="onboarding-form" class="bg-white p-8 rounded-2xl shadow-lg">
                <div class="mb-12">
                     <h1 class="text-3xl font-extrabold text-gray-900 text-center">Build Your Profile</h1>
                     <p class="text-center text-lg text-gray-600 mt-2">To provide the most accurate AI matches, please tell us about your organization.</p>
                     <div class="mt-8 flex w-full items-center">
                         <div class="w-1/3 text-center step step-active" data-step="1">
                            <div class="step-circle relative z-10 mx-auto flex h-8 w-8 items-center justify-center rounded-full border-2 font-bold transition-colors duration-300">1</div>
                            <p class="step-label mt-2 hidden text-sm font-semibold text-gray-500 md:block transition-colors duration-300">Charity Info</p>
                         </div>
                         <div class="flex-1 -mx-4"><div class="h-0.5 bg-gray-200 step-line transition-colors duration-300"></div></div>
                         <div class="w-1/3 text-center step" data-step="2">
                            <div class="step-circle relative z-10 mx-auto flex h-8 w-8 items-center justify-center rounded-full border-2 border-gray-300 font-bold text-gray-500 transition-colors duration-300">2</div>
                            <p class="step-label mt-2 hidden text-sm font-semibold text-gray-500 md:block transition-colors duration-300">Contact Info</p>
                         </div>
                         <div class="flex-1 -mx-4"><div class="h-0.5 bg-gray-200 step-line transition-colors duration-300"></div></div>
                         <div class="w-1/3 text-center step" data-step="3">
                            <div class="step-circle relative z-10 mx-auto flex h-8 w-8 items-center justify-center rounded-full border-2 border-gray-300 font-bold text-gray-500 transition-colors duration-300">3</div>
                            <p class="step-label mt-2 hidden text-sm font-semibold text-gray-500 md:block transition-colors duration-300">Project Details</p>
                        </div>
                     </div>
                </div>

                <div class="mt-8 space-y-8">
                    <div class="form-step active" data-step="1">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">1. Charity Information</h2>
                            <p class="text-gray-500 mt-1">Tell us about the organization you represent.</p>
                             <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="md:col-span-2"><label for="charity_name" class="block text-sm font-medium text-gray-700">Official Charity Name</label><input type="text" name="charity_name" id="charity_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div>
                                <div><label for="charity_ein" class="block text-sm font-medium text-gray-700">Charity EIN / Reg. No.</label><input type="text" name="charity_ein" id="charity_ein" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div>
                                <div><label for="charity_phone" class="block text-sm font-medium text-gray-700">Charity Phone</label><input type="tel" name="charity_phone" id="charity_phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div>
                                <div class="md:col-span-2"><label for="address_1" class="block text-sm font-medium text-gray-700">Mailing Address</label><input type="text" name="address_1" id="address_1" required placeholder="Street Address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div>
                                <div><label for="country" class="block text-sm font-medium text-gray-700">Country</label><select id="country" name="country" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="">Select Country</option></select></div>
                                <div><label for="state" class="block text-sm font-medium text-gray-700">State / Province</label><select id="state" name="state" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 disabled:bg-gray-200" disabled><option value="">Select State / Province</option></select></div>
                                <div><label for="city" class="block text-sm font-medium text-gray-700">City</label><input type="text" name="city" id="city" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div>
                                <div><label for="zip_code" class="block text-sm font-medium text-gray-700">ZIP / Postal Code</label><input type="text" name="zip_code" id="zip_code" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-step hidden" data-step="2">
                         <div>
                            <h2 class="text-xl font-bold text-gray-900">2. Your Contact Information</h2>
                            <p class="text-gray-500 mt-1">Who is the primary contact for grant-related communications?</p>
                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="contact_name" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" name="contact_name" id="contact_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div>
                                <div><label for="contact_title" class="block text-sm font-medium text-gray-700">Title / Role</label><input type="text" name="contact_title" id="contact_title" placeholder="e.g., Executive Director" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div>
                                <div class="md:col-span-2"><label for="contact_phone" class="block text-sm font-medium text-gray-700">Phone Number</label><input type="tel" name="contact_phone" id="contact_phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-step hidden" data-step="3">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">3. Project Details</h2>
                            <p class="text-gray-500 mt-1">Provide the details our AI needs to find your perfect matches.</p>
                            <div class="mt-6 grid grid-cols-1 gap-y-6">
                                <div><label for="mission_statement" class="block text-sm font-medium text-gray-700">Your Organization's Mission Statement</label><textarea id="mission_statement" name="mission_statement" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="e.g., Our mission is to end homelessness in our city by providing shelter, support services..."></textarea></div>
                                <div><label for="program_description" class="block text-sm font-medium text-gray-700">Detailed Program Description</label><textarea id="program_description" name="program_description" rows="6" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500" placeholder="Be specific! Describe the activities, goals, and target population for the program needing funding."></textarea></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-8 flex justify-between">
                    <button type="button" id="prev-btn" class="bg-gray-200 text-gray-800 font-bold py-3 px-8 rounded-lg hover:bg-gray-300 transition-colors hidden">Previous</button>
                    <button type="button" id="next-btn" class="cta-gradient-button ml-auto">Next Step</button>
                    <button type="submit" id="submit-btn" class="cta-gradient-button hidden">Create Profile & Find Matches</button>
                </div>
                <div id="form-status" class="mt-4 text-center text-sm font-medium"></div>
            </form>
        </div>
    </main>

    <script>
        // JS Logic is solid, no changes needed here.
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('onboarding-form');
            const statusDiv = document.getElementById('form-status');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');
            const steps = document.querySelectorAll('.form-step');
            const stepperIndicators = document.querySelectorAll('.step');
            const countrySelect = document.getElementById('country');
            const stateSelect = document.getElementById('state');
            
            let currentStep = 1;

            const locations = { "United States": ["Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming"], "Canada": ["Alberta", "British Columbia", "Manitoba", "New Brunswick", "Newfoundland and Labrador", "Nova Scotia", "Ontario", "Prince Edward Island", "Quebec", "Saskatchewan"] };

            for (const country in locations) {
                countrySelect.add(new Option(country, country));
            }

            countrySelect.addEventListener('change', () => {
                stateSelect.innerHTML = '<option value="">Select State / Province</option>';
                const selectedCountry = countrySelect.value;
                if (selectedCountry && locations[selectedCountry]) {
                    stateSelect.disabled = false;
                    locations[selectedCountry].forEach(state => stateSelect.add(new Option(state, state)));
                } else {
                    stateSelect.disabled = true;
                }
            });
            
            const updateUI = () => {
                prevBtn.classList.toggle('hidden', currentStep === 1);
                nextBtn.classList.toggle('hidden', currentStep === steps.length);
                submitBtn.classList.toggle('hidden', currentStep !== steps.length);

                stepperIndicators.forEach(indicator => {
                    const indicatorStep = parseInt(indicator.dataset.step);
                    indicator.classList.remove('step-active', 'step-completed');
                    if (indicatorStep < currentStep) {
                        indicator.classList.add('step-completed');
                    } else if (indicatorStep === currentStep) {
                        indicator.classList.add('step-active');
                    }
                });
                
                steps.forEach(step => {
                    step.classList.toggle('hidden', parseInt(step.dataset.step) !== currentStep);
                });
            };

            const validateStep = (stepNumber) => {
                const stepDiv = document.querySelector(`.form-step[data-step="${stepNumber}"]`);
                const inputs = stepDiv.querySelectorAll('input[required], textarea[required], select[required]');
                for (const input of inputs) {
                    if (!input.reportValidity()) {
                        return false;
                    }
                }
                return true;
            };

            nextBtn.addEventListener('click', () => {
                if (validateStep(currentStep) && currentStep < steps.length) {
                    currentStep++;
                    updateUI();
                }
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 1) {
                    currentStep--;
                    updateUI();
                }
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateStep(currentStep)) return;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="flex items-center justify-center">Saving... <svg class="animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>';
                statusDiv.textContent = '';

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/api/save-profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        statusDiv.className = 'text-green-600';
                        statusDiv.textContent = 'Profile saved! Redirecting to your dashboard...';
                        setTimeout(() => { window.location.href = '/dashboard'; }, 1500);
                    } else {
                        throw new Error(result.error || 'Failed to save profile.');
                    }
                } catch (error) {
                    statusDiv.className = 'text-red-600';
                    statusDiv.textContent = `An error occurred: ${error.message}. Please try again.`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Profile & Find Matches';
                }
            });
            
            updateUI();
        });
    </script>
</body>
</html>